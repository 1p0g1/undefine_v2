"use strict";(()=>{var e={};e.id=68,e.ids=[68],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},3246:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{config:()=>p,default:()=>l,routeModule:()=>u});var a=t(1802),o=t(7153),d=t(6249),i=t(3220),n=e([i]);i=(n.then?(await n)():n)[0];let l=(0,d.l)(i,"default"),p=(0,d.l)(i,"config"),u=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/admin/populate-leaderboard",pathname:"/api/admin/populate-leaderboard",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},3220:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{default:()=>i,populateLeaderboard:()=>n});var a=t(2885),o=t(9085),d=e([o]);o=(d.then?(await d)():d)[0];let c=(0,a.createClient)(o.O.SUPABASE_URL,o.O.SUPABASE_SERVICE_ROLE_KEY);async function i(e,r){if("POST"!==e.method)return r.status(405).json({success:!1,message:"Method not allowed",stats:{processed:0,inserted:0,updated:0,skipped:0,errors:0},details:[]});let{wordId:t,playerId:s,backfill:a,validate:o}=e.body;console.log("[/api/admin/populate-leaderboard] Starting leaderboard population:",{wordId:t,playerId:s,backfill:a,validate:o});try{let e=await n({wordId:t,playerId:s,backfill:a||!1,validate:o||!1});return r.status(200).json(e)}catch(e){return console.error("[/api/admin/populate-leaderboard] Population failed:",e),r.status(500).json({success:!1,message:e instanceof Error?e.message:"Unknown error",stats:{processed:0,inserted:0,updated:0,skipped:0,errors:1},details:[{player_id:s||"unknown",word_id:t||"unknown",action:"error",error:e instanceof Error?e.message:"Unknown error"}]})}}async function n(e){let{wordId:r,playerId:t,backfill:s=!1,validate:a=!1}=e,o={success:!0,message:"",stats:{processed:0,inserted:0,updated:0,skipped:0,errors:0},details:[]};console.log("[populateLeaderboard] Starting with options:",e);try{let e=c.from("game_sessions").select(`
        id,
        player_id,
        word_id,
        start_time,
        end_time,
        guesses,
        guesses_used,
        is_complete,
        is_won
      `).eq("is_complete",!0).eq("is_won",!0);if(r&&(e=e.eq("word_id",r)),t&&(e=e.eq("player_id",t)),!s){let r=new Date;r.setDate(r.getDate()-7),e=e.gte("end_time",r.toISOString())}let{data:d,error:i}=await e;if(i)throw Error(`Failed to fetch completed games: ${i.message}`);if(!d||0===d.length)return o.message="No completed games found to process",o;for(let e of(console.log(`[populateLeaderboard] Found ${d.length} completed games to process`),d))try{if(o.stats.processed++,!e.start_time||!e.end_time){o.details.push({player_id:e.player_id,word_id:e.word_id,action:"skipped",reason:"Missing start_time or end_time"}),o.stats.skipped++;continue}let r=Math.floor((new Date(e.end_time).getTime()-new Date(e.start_time).getTime())/1e3),t=e.guesses_used||(e.guesses?e.guesses.length:0);if(r<=0||t<=0){o.details.push({player_id:e.player_id,word_id:e.word_id,action:"skipped",reason:`Invalid metrics: time=${r}s, guesses=${t}`}),o.stats.skipped++;continue}await l(e.player_id);let s=await p({player_id:e.player_id,word_id:e.word_id,best_time:r,guesses_used:t,date:new Date(e.end_time).toISOString().split("T")[0]});o.details.push({player_id:e.player_id,word_id:e.word_id,action:s}),"inserted"===s?o.stats.inserted++:"updated"===s?o.stats.updated++:o.stats.skipped++}catch(r){console.error(`[populateLeaderboard] Error processing game ${e.id}:`,r),o.stats.errors++,o.details.push({player_id:e.player_id,word_id:e.word_id,action:"error",error:r instanceof Error?r.message:"Unknown error"})}let n=Array.from(new Set(d.map(e=>e.word_id)));for(let e of(console.log(`[populateLeaderboard] Updating rankings for ${n.length} words`),n))try{await u(e)}catch(r){console.error(`[populateLeaderboard] Failed to update rankings for word ${e}:`,r),o.stats.errors++}if(a){let e=await _(r);o.message+=` Validation: ${e.message}`}return o.message=o.message||`Successfully processed ${o.stats.processed} games. Inserted: ${o.stats.inserted}, Updated: ${o.stats.updated}, Skipped: ${o.stats.skipped}, Errors: ${o.stats.errors}`,o.success=0===o.stats.errors,console.log("[populateLeaderboard] Completed:",o.stats),o}catch(e){return console.error("[populateLeaderboard] Fatal error:",e),o.success=!1,o.message=e instanceof Error?e.message:"Unknown error",o.stats.errors++,o}}async function l(e){console.log("[ensureUserStatsEntry] Skipping user_stats - foreign key points to players.id")}async function p(e){let{data:r}=await c.from("leaderboard_summary").select("id, best_time, guesses_used").eq("player_id",e.player_id).eq("word_id",e.word_id).single();if(r){if(!(e.best_time<r.best_time)&&(e.best_time!==r.best_time||!(e.guesses_used<r.guesses_used)))return"skipped";{let{error:r}=await c.from("leaderboard_summary").update({best_time:e.best_time,guesses_used:e.guesses_used,date:e.date}).eq("player_id",e.player_id).eq("word_id",e.word_id);if(r)throw Error(`Failed to update leaderboard entry: ${r.message}`);return"updated"}}{let{error:r}=await c.from("leaderboard_summary").insert({player_id:e.player_id,word_id:e.word_id,rank:1,was_top_10:!0,best_time:e.best_time,guesses_used:e.guesses_used,date:e.date});if(r)throw Error(`Failed to insert leaderboard entry: ${r.message}`);return"inserted"}}async function u(e){let{data:r,error:t}=await c.from("leaderboard_summary").select("id, player_id, best_time, guesses_used").eq("word_id",e).order("best_time",{ascending:!0}).order("guesses_used",{ascending:!0});if(t)throw Error(`Failed to fetch leaderboard entries: ${t.message}`);if(r&&0!==r.length)for(let e=0;e<r.length;e++){let t=e+1,s=t<=10,{error:a}=await c.from("leaderboard_summary").update({rank:t,was_top_10:s}).eq("id",r[e].id);a&&console.error(`Failed to update rank for entry ${r[e].id}:`,a)}}async function _(e){let r=c.from("game_sessions").select("player_id, word_id").eq("is_complete",!0).eq("is_won",!0),t=c.from("leaderboard_summary").select("player_id, word_id");e&&(r=r.eq("word_id",e),t=t.eq("word_id",e));let[s,a]=await Promise.all([r,t]);if(s.error||a.error)return{valid:!1,message:"Failed to fetch validation data",missingCount:0};let o=new Set(s.data?.map(e=>`${e.player_id}:${e.word_id}`)||[]),d=new Set(a.data?.map(e=>`${e.player_id}:${e.word_id}`)||[]),i=Array.from(o).filter(e=>!d.has(e));return{valid:0===i.length,message:0===i.length?"All completed games are present in leaderboard":`${i.length} completed games missing from leaderboard`,missingCount:i.length}}s()}catch(e){s(e)}})},9085:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.d(r,{O:()=>i});var a=t(9926),o=e([a]);let d=(a=(o.then?(await o)():o)[0]).z.object({SUPABASE_URL:a.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:a.z.string(),SUPABASE_ANON_KEY:a.z.string(),DB_PROVIDER:a.z.literal("supabase"),NODE_ENV:a.z.enum(["development","production"]).default("production"),PORT:a.z.string().transform(Number).default("3001"),FRONTEND_URL:a.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:"supabase",NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!d.success)throw console.error("âŒ Invalid environment variables:\n",Object.entries(d.error.flatten().fieldErrors).map(([e,r])=>`${e}: ${r?.join(", ")}`).join("\n")),Error("Invalid environment variables");let i=d.data;s()}catch(e){s(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=3246);module.exports=t})();