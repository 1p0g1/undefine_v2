"use strict";(()=>{var e={};e.id=352,e.ids=[352],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},7585:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{config:()=>c,default:()=>l,routeModule:()=>_});var o=t(1802),i=t(7153),n=t(6249),s=t(5083),d=e([s]);s=(d.then?(await d)():d)[0];let l=(0,n.l)(s,"default"),c=(0,n.l)(s,"config"),_=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/leaderboard",pathname:"/api/leaderboard",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},7274:(e,r,t)=>{t.d(r,{o:()=>a});function a(e){return async(r,t)=>{if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Player-ID, Authorization"),"OPTIONS"===r.method){t.status(204).end();return}return e(r,t)}}},5083:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{default:()=>f});var o=t(2885),i=t(9085),n=t(7274),s=e([i]);if(!(i=(s.then?(await s)():s)[0]).O.SUPABASE_URL)throw console.error("❌ Missing SUPABASE_URL in env"),Error("Missing SUPABASE_URL");if(!i.O.SUPABASE_SERVICE_ROLE_KEY)throw console.error("❌ Missing SUPABASE_SERVICE_ROLE_KEY in env"),Error("Missing SUPABASE_SERVICE_ROLE_KEY");if(!i.O.DB_PROVIDER)throw console.error("❌ Missing DB_PROVIDER in env"),Error("Missing DB_PROVIDER");console.log("[/api/leaderboard] Environment validation passed:",{hasSupabaseUrl:!!i.O.SUPABASE_URL,hasServiceRoleKey:!!i.O.SUPABASE_SERVICE_ROLE_KEY,dbProvider:i.O.DB_PROVIDER,nodeEnv:i.O.NODE_ENV});let p=(0,o.createClient)(i.O.SUPABASE_URL,i.O.SUPABASE_SERVICE_ROLE_KEY);async function d(e,r){if("GET"!==e.method)return r.status(405).json({error:"Method not allowed"});let{wordId:t,playerId:a,date:o}=e.query;if(!t||"string"!=typeof t)return r.status(400).json({error:"wordId is required"});try{let e=o&&"string"==typeof o?o:u(),i=e===u();console.log("[/api/leaderboard] Fetching leaderboard for:",{wordId:t,playerId:"string"==typeof a?a:void 0,targetDate:e,isCurrentDay:i});let n=[],s=0;if(i){let e=await l(t,"string"==typeof a?a:void 0);n=e.entries,s=e.totalEntries}else{let r=await c(t,e,"string"==typeof a?a:void 0);n=r.entries,s=r.totalEntries}let d=n.find(e=>e.player_id===("string"==typeof a?a:void 0)),_=d?.rank||null;return console.log("[/api/leaderboard] Successfully returning leaderboard:",{entryCount:n.length,totalEntries:s,playerRank:_,source:i?"real-time":"snapshot"}),r.status(200).json({leaderboard:n,playerRank:_,totalEntries:s})}catch(e){return console.error("[/api/leaderboard] Unexpected error in leaderboard handler:",{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),r.status(500).json({error:"Internal server error: "+(e instanceof Error?e.message:"Unknown error")})}}async function l(e,r){console.log("[getCurrentDayLeaderboard] Fetching real-time data for:",e);let{data:t,error:a}=await p.from("leaderboard_summary").select(`
      id,
      player_id,
      word_id,
      rank,
      best_time,
      guesses_used,
      was_top_10,
      date
    `).eq("word_id",e).order("rank",{ascending:!0});if(a)throw console.error("[getCurrentDayLeaderboard] Query failed:",a.message),Error(`Failed to fetch current leaderboard: ${a.message}`);if(!t||0===t.length)return console.log("[getCurrentDayLeaderboard] No entries found for current day"),{entries:[],totalEntries:0};let o=t.map(e=>e.player_id),{data:i}=await p.from("players").select("id, display_name").in("id",o),n=new Map(i?.map(e=>[e.id,e.display_name||`Player ${e.id.slice(-4)}`])||[]),{data:s}=await p.from("scores").select("player_id, word_id, fuzzy_bonus").eq("word_id",e).in("player_id",o),d=new Map((s||[]).map(e=>[e.player_id,{fuzzy_bonus:e.fuzzy_bonus||0,fuzzy_matches:Math.floor((e.fuzzy_bonus||0)/25)}])),{data:l}=await p.from("words").select("theme, date").eq("id",e).single(),c=new Map;if(l?.theme){let{data:e}=await p.from("theme_attempts").select("player_id, theme, is_correct, confidence_percentage").eq("theme",l.theme).in("player_id",o);if(e)for(let r of e)c.set(r.player_id,{hasGuessed:!0,isCorrect:r.is_correct,confidence:r.confidence_percentage})}let _=t.map(e=>{let t=d.get(e.player_id),a=c.get(e.player_id);return{id:e.id,word_id:e.word_id,player_id:e.player_id,player_name:n.get(e.player_id)||`Player ${e.player_id.slice(-4)}`,rank:e.rank||0,guesses_used:e.guesses_used||0,best_time:e.best_time||0,date:e.date||u(),created_at:new Date().toISOString(),was_top_10:e.was_top_10||!1,is_current_player:e.player_id===r,fuzzy_matches:t?.fuzzy_matches||0,fuzzy_bonus:t?.fuzzy_bonus||0,theme_guess_data:a?{has_guessed:a.hasGuessed,is_correct:a.isCorrect,confidence_percentage:a.confidence}:void 0}}),f=_.slice(0,10),g=_.find(e=>e.player_id===r),y=[...f];return g&&!f.find(e=>e.player_id===r)&&y.push(g),{entries:y,totalEntries:_.length}}async function c(e,r,t){console.log("[getHistoricalLeaderboard] Fetching snapshot data for:",{wordId:e,date:r});try{let{data:a,error:o}=await p.rpc("get_historical_leaderboard",{target_word_id:e,target_date:r});if(o)return console.error("[getHistoricalLeaderboard] Snapshot query failed:",o.message),await l(e,t);if(!a||0===a.length){console.log("[getHistoricalLeaderboard] No snapshot found, checking if day should be finalized");let{data:a}=await p.rpc("should_finalize_date",{check_date:r});if(a){console.log("[getHistoricalLeaderboard] Date should be finalized, attempting auto-finalization");let{data:a}=await p.rpc("finalize_daily_leaderboard",{target_word_id:e,target_date:r});if(a?.[0]?.success){console.log("[getHistoricalLeaderboard] Auto-finalization successful, retrying snapshot query");let{data:a,error:o}=await p.rpc("get_historical_leaderboard",{target_word_id:e,target_date:r});if(!o&&a&&a.length>0)return _(a,t)}}return console.log("[getHistoricalLeaderboard] No snapshot available, falling back to real-time query"),await l(e,t)}return _(a,t)}catch(r){return console.error("[getHistoricalLeaderboard] Error fetching historical data:",r),await l(e,t)}}function _(e,r){let t=e.map(e=>({id:`snapshot-${e.player_id}`,word_id:e.word_id||"",player_id:e.player_id,player_name:e.player_name,rank:e.rank,guesses_used:e.guesses_used,best_time:e.best_time,date:u(),created_at:new Date().toISOString(),was_top_10:e.was_top_10,is_current_player:e.player_id===r,fuzzy_matches:e.fuzzy_matches||0,fuzzy_bonus:e.fuzzy_bonus||0})),a=t.slice(0,10),o=t.find(e=>e.player_id===r),i=[...a];return o&&!a.find(e=>e.player_id===r)&&i.push(o),{entries:i,totalEntries:t.length}}function u(){let e=new Date;return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}let f=(0,n.o)(d);a()}catch(e){a(e)}})},9085:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.d(r,{O:()=>s});var o=t(9926),i=e([o]);let n=(o=(i.then?(await i)():i)[0]).z.object({SUPABASE_URL:o.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:o.z.string(),SUPABASE_ANON_KEY:o.z.string(),DB_PROVIDER:o.z.literal("supabase"),NODE_ENV:o.z.enum(["development","production"]).default("production"),PORT:o.z.string().transform(Number).default("3001"),FRONTEND_URL:o.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:"supabase",NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!n.success)throw console.error("❌ Invalid environment variables:\n",Object.entries(n.error.flatten().fieldErrors).map(([e,r])=>`${e}: ${r?.join(", ")}`).join("\n")),Error("Invalid environment variables");let s=n.data;a()}catch(e){a(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=7585);module.exports=t})();