"use strict";(()=>{var e={};e.id=352,e.ids=[352],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,o){return o in r?r[o]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,o)):"function"==typeof r&&"default"===o?r:void 0}}})},7585:(e,r,o)=>{o.a(e,async(e,s)=>{try{o.r(r),o.d(r,{config:()=>c,default:()=>l,routeModule:()=>_});var t=o(1802),a=o(7153),n=o(6249),i=o(5083),d=e([i]);i=(d.then?(await d)():d)[0];let l=(0,n.l)(i,"default"),c=(0,n.l)(i,"config"),_=new t.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/leaderboard",pathname:"/api/leaderboard",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},7274:(e,r,o)=>{o.d(r,{o:()=>s});function s(e){return async(r,o)=>{if(o.setHeader("Access-Control-Allow-Origin","*"),o.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),o.setHeader("Access-Control-Allow-Headers","Content-Type, Player-ID, Authorization"),"OPTIONS"===r.method){o.status(204).end();return}return e(r,o)}}},5083:(e,r,o)=>{o.a(e,async(e,s)=>{try{o.r(r),o.d(r,{default:()=>c});var t=o(2885),a=o(9085),n=o(7274),i=e([a]);if(!(a=(i.then?(await i)():i)[0]).O.SUPABASE_URL)throw console.error("❌ Missing SUPABASE_URL in env"),Error("Missing SUPABASE_URL");if(!a.O.SUPABASE_SERVICE_ROLE_KEY)throw console.error("❌ Missing SUPABASE_SERVICE_ROLE_KEY in env"),Error("Missing SUPABASE_SERVICE_ROLE_KEY");if(!a.O.DB_PROVIDER)throw console.error("❌ Missing DB_PROVIDER in env"),Error("Missing DB_PROVIDER");console.log("[/api/leaderboard] Environment validation passed:",{hasSupabaseUrl:!!a.O.SUPABASE_URL,hasServiceRoleKey:!!a.O.SUPABASE_SERVICE_ROLE_KEY,dbProvider:a.O.DB_PROVIDER,nodeEnv:a.O.NODE_ENV});let l=(0,t.createClient)(a.O.SUPABASE_URL,a.O.SUPABASE_SERVICE_ROLE_KEY);async function d(e,r){if("GET"!==e.method)return r.status(405).json({error:"Method not allowed"});let{wordId:o,playerId:s}=e.query;if(!o||"string"!=typeof o)return r.status(400).json({error:"wordId is required"});try{console.log("[/api/leaderboard] Fetching leaderboard for wordId:",o,"playerId:",s);let{data:e,error:t}=await l.from("leaderboard_summary").select(`
        id,
        player_id,
        word_id,
        rank,
        score,
        completion_time_seconds,
        guesses_used,
        was_top_10,
        created_at
      `).eq("word_id",o).order("score",{ascending:!1}).order("completion_time_seconds",{ascending:!0});if(console.log("[/api/leaderboard] Leaderboard_summary query result:",{success:!t,entryCount:e?.length||0,error:t?.message}),t||!e||0===e.length){console.log("[/api/leaderboard] Falling back to scores table...");let{data:s,error:a}=await l.from("scores").select(`
          id,
          player_id,
          word_id,
          score,
          completion_time_seconds,
          guesses_used,
          submitted_at
        `).eq("word_id",o).eq("correct",!0).order("score",{ascending:!1}).order("completion_time_seconds",{ascending:!0});if(console.log("[/api/leaderboard] Scores table query result:",{success:!a,entryCount:s?.length||0,error:a?.message}),a)return console.error("[/api/leaderboard] Both leaderboard_summary and scores failed:",{leaderboardError:t?.message,scoresError:a.message}),r.status(500).json({error:"Database access failed: "+a.message});e=(s||[]).map((e,r)=>({id:e.id,player_id:e.player_id,word_id:e.word_id,rank:r+1,score:e.score||0,completion_time_seconds:e.completion_time_seconds,guesses_used:e.guesses_used,was_top_10:r+1<=10,created_at:e.submitted_at||new Date().toISOString()}))}if(console.log("[/api/leaderboard] Final data:",{entryCount:e?.length||0}),!e||0===e.length)return console.log("[/api/leaderboard] No entries found for word:",o),r.status(200).json({leaderboard:[],playerRank:null,totalEntries:0});let a=e.map((e,r)=>({id:e.id,word_id:e.word_id,player_id:e.player_id,player_name:`Player ${e.player_id.slice(-4)}`,rank:r+1,guesses_used:e.guesses_used,completion_time_seconds:e.completion_time_seconds,score:e.score||0,date:e.created_at?.split("T")[0]||new Date().toISOString().split("T")[0],created_at:e.created_at||new Date().toISOString(),was_top_10:r+1<=10,is_current_player:e.player_id===s})),n=null,i=null;s&&"string"==typeof s&&(n=a.find(e=>e.player_id===s)??null)&&(i=n.rank);let d=a.slice(0,10),c=[...d];return n&&!d.find(e=>e.player_id===s)&&c.push(n),console.log("[/api/leaderboard] Successfully returning leaderboard with",c.length,"entries"),r.status(200).json({leaderboard:c,playerRank:i,totalEntries:a.length})}catch(e){return console.error("[/api/leaderboard] Unexpected error in leaderboard handler:",{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),r.status(500).json({error:"Internal server error: "+(e instanceof Error?e.message:"Unknown error")})}}let c=(0,n.o)(d);s()}catch(e){s(e)}})},9085:(e,r,o)=>{o.a(e,async(e,s)=>{try{o.d(r,{O:()=>i});var t=o(9926),a=e([t]);let n=(t=(a.then?(await a)():a)[0]).z.object({SUPABASE_URL:t.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:t.z.string(),SUPABASE_ANON_KEY:t.z.string(),DB_PROVIDER:t.z.literal("supabase"),NODE_ENV:t.z.enum(["development","production"]).default("production"),PORT:t.z.string().transform(Number).default("3001"),FRONTEND_URL:t.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:process.env.DB_PROVIDER,NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!n.success)throw console.error("❌ Invalid environment variables:\n",Object.entries(n.error.flatten().fieldErrors).map(([e,r])=>`${e}: ${r?.join(", ")}`).join("\n")),Error("Invalid environment variables");let i=n.data;s()}catch(e){s(e)}})},7153:(e,r)=>{var o;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,r,o)=>{e.exports=o(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var o=r(r.s=7585);module.exports=o})();