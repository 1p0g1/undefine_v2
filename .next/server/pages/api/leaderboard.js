"use strict";(()=>{var e={};e.id=352,e.ids=[352],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,a){return a in r?r[a]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,a)):"function"==typeof r&&"default"===a?r:void 0}}})},7585:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.r(r),a.d(r,{config:()=>c,default:()=>l,routeModule:()=>_});var s=a(1802),o=a(7153),n=a(6249),i=a(5083),d=e([i]);i=(d.then?(await d)():d)[0];let l=(0,n.l)(i,"default"),c=(0,n.l)(i,"config"),_=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/leaderboard",pathname:"/api/leaderboard",bundlePath:"",filename:""},userland:i});t()}catch(e){t(e)}})},7274:(e,r,a)=>{a.d(r,{o:()=>t});function t(e){return async(r,a)=>{if(a.setHeader("Access-Control-Allow-Origin","*"),a.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),a.setHeader("Access-Control-Allow-Headers","Content-Type, Player-ID, Authorization"),"OPTIONS"===r.method){a.status(204).end();return}return e(r,a)}}},5083:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.r(r),a.d(r,{default:()=>c});var s=a(2885),o=a(9085),n=a(7274),i=e([o]);if(!(o=(i.then?(await i)():i)[0]).O.SUPABASE_URL)throw console.error("❌ Missing SUPABASE_URL in env"),Error("Missing SUPABASE_URL");if(!o.O.SUPABASE_SERVICE_ROLE_KEY)throw console.error("❌ Missing SUPABASE_SERVICE_ROLE_KEY in env"),Error("Missing SUPABASE_SERVICE_ROLE_KEY");if(!o.O.DB_PROVIDER)throw console.error("❌ Missing DB_PROVIDER in env"),Error("Missing DB_PROVIDER");console.log("[/api/leaderboard] Environment validation passed:",{hasSupabaseUrl:!!o.O.SUPABASE_URL,hasServiceRoleKey:!!o.O.SUPABASE_SERVICE_ROLE_KEY,dbProvider:o.O.DB_PROVIDER,nodeEnv:o.O.NODE_ENV});let l=(0,s.createClient)(o.O.SUPABASE_URL,o.O.SUPABASE_SERVICE_ROLE_KEY);async function d(e,r){if("GET"!==e.method)return r.status(405).json({error:"Method not allowed"});let{wordId:a,playerId:t}=e.query;if(!a||"string"!=typeof a)return r.status(400).json({error:"wordId is required"});try{console.log("[/api/leaderboard] Fetching leaderboard for wordId:",a,"playerId:",t);let{data:e,error:s}=await l.from("leaderboard_summary").select(`
        id,
        player_id,
        word_id,
        rank,
        best_time,
        guesses_used,
        was_top_10,
        date
      `).eq("word_id",a).eq("date",new Date().toISOString().split("T")[0]).order("rank",{ascending:!0});if(console.log("[/api/leaderboard] Leaderboard_summary query result:",{success:!s,entryCount:e?.length||0,error:s?.message}),s||!e||0===e.length){console.log("[/api/leaderboard] Falling back to scores table...");let{data:t,error:o}=await l.from("scores").select(`
          id,
          player_id,
          word_id,
          score,
          completion_time_seconds,
          guesses_used,
          submitted_at
        `).eq("word_id",a).eq("correct",!0).order("score",{ascending:!1}).order("completion_time_seconds",{ascending:!0});if(console.log("[/api/leaderboard] Scores table query result:",{success:!o,entryCount:t?.length||0,error:o?.message}),o)return console.error("[/api/leaderboard] Both leaderboard_summary and scores failed:",{leaderboardError:s?.message,scoresError:o.message}),r.status(500).json({error:"Database access failed: "+o.message});e=(t||[]).map((e,r)=>({id:e.id,player_id:e.player_id,word_id:e.word_id,rank:r+1,best_time:e.completion_time_seconds,guesses_used:e.guesses_used,was_top_10:r+1<=10,date:e.submitted_at?.split("T")[0]||new Date().toISOString().split("T")[0]}))}if(console.log("[/api/leaderboard] Final data:",{entryCount:e?.length||0}),!e||0===e.length)return console.log("[/api/leaderboard] No entries found for word:",a),r.status(200).json({leaderboard:[],playerRank:null,totalEntries:0});let o=e.map(e=>e.player_id),{data:n}=await l.from("players").select("id, display_name").in("id",o),i=new Map(n?.map(e=>[e.id,e.display_name||`Player ${e.id.slice(-4)}`])||[]),d=e.map(e=>({id:e.id,word_id:e.word_id,player_id:e.player_id,player_name:i.get(e.player_id)||`Player ${e.player_id.slice(-4)}`,rank:e.rank||0,guesses_used:e.guesses_used||0,best_time:e.best_time||0,date:e.date||new Date().toISOString().split("T")[0],created_at:new Date().toISOString(),was_top_10:e.was_top_10||!1,is_current_player:e.player_id===t})),c=null,_=null;t&&"string"==typeof t&&(c=d.find(e=>e.player_id===t)??null)&&(_=c.rank);let u=d.slice(0,10),p=[...u];return c&&!u.find(e=>e.player_id===t)&&p.push(c),console.log("[/api/leaderboard] Successfully returning leaderboard with",p.length,"entries"),r.status(200).json({leaderboard:p,playerRank:_,totalEntries:d.length})}catch(e){return console.error("[/api/leaderboard] Unexpected error in leaderboard handler:",{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),r.status(500).json({error:"Internal server error: "+(e instanceof Error?e.message:"Unknown error")})}}let c=(0,n.o)(d);t()}catch(e){t(e)}})},9085:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.d(r,{O:()=>i});var s=a(9926),o=e([s]);let n=(s=(o.then?(await o)():o)[0]).z.object({SUPABASE_URL:s.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:s.z.string(),SUPABASE_ANON_KEY:s.z.string(),DB_PROVIDER:s.z.literal("supabase"),NODE_ENV:s.z.enum(["development","production"]).default("production"),PORT:s.z.string().transform(Number).default("3001"),FRONTEND_URL:s.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:process.env.DB_PROVIDER,NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!n.success)throw console.error("❌ Invalid environment variables:\n",Object.entries(n.error.flatten().fieldErrors).map(([e,r])=>`${e}: ${r?.join(", ")}`).join("\n")),Error("Invalid environment variables");let i=n.data;t()}catch(e){t(e)}})},7153:(e,r)=>{var a;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,r,a)=>{e.exports=a(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var a=r(r.s=7585);module.exports=a})();