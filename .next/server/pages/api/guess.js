"use strict";(()=>{var e={};e.id=310,e.ids=[310],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6555:e=>{e.exports=import("uuid")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},141:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>d,routeModule:()=>c});var a=r(1802),o=r(7153),n=r(6249),i=r(5274),l=e([i]);i=(l.then?(await l)():l)[0];let d=(0,n.l)(i,"default"),u=(0,n.l)(i,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/guess",pathname:"/api/guess",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},7428:(e,t,r)=>{r.d(t,{o:()=>a});let s=["https://undefine-v2-front.vercel.app","http://localhost:3000"];function a(e){return async(t,r)=>{let a=t.headers.origin||"";if(s.includes(a)&&(r.setHeader("Access-Control-Allow-Origin",a),r.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,POST"),r.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, Player-ID"),r.setHeader("Access-Control-Allow-Credentials","true")),"OPTIONS"===t.method){r.status(200).end();return}try{await e(t,r)}catch(e){console.error("[CORS Middleware] Handler error:",e),r.status(500).json({error:"Internal server error",details:void 0})}}}},5274:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{default:()=>p});var a=r(2885),o=r(9085),n=r(6555),i=r(8467),l=r(7428),d=e([o,n]);[o,n]=d.then?(await d)():d;let m=(0,a.createClient)(o.O.SUPABASE_URL,o.O.SUPABASE_SERVICE_ROLE_KEY);async function u(e,t,r,s){if(!s)throw Error("Completion time is required for updating stats");let{data:a,error:o}=await m.from("user_stats").select("*").eq("player_id",e).single();if(o)throw console.error("[updateUserStats] Failed to fetch stats:",o),o;let n={games_played:(a?.games_played||0)+1,games_won:t?(a?.games_won||0)+1:a?.games_won||0,current_streak:t?(a?.current_streak||0)+1:0,longest_streak:t?Math.max(a?.longest_streak||0,(a?.current_streak||0)+1):a?.longest_streak||0,total_guesses:(a?.total_guesses||0)+r,average_guesses_per_game:((a?.total_guesses||0)+r)/((a?.games_played||0)+1),total_play_time_seconds:(a?.total_play_time_seconds||0)+s,updated_at:new Date().toISOString()},{error:i}=await m.from("user_stats").update(n).eq("player_id",e);if(i)throw console.error("[updateUserStats] Failed to update stats:",i),i;return n}async function c(e,t,r,s,a){if(!s)throw Error("Completion time is required for creating score entry");let{error:o}=await m.from("scores").insert([{player_id:e,word_id:t,guesses_used:r,completion_time_seconds:s,was_correct:a,submitted_at:new Date().toISOString()}]);if(o)throw console.error("[createScoreEntry] Failed to create score:",o),o}async function _(e,t,r,s){if(!s)throw Error("Completion time is required for updating leaderboard");let{data:a,error:o}=await m.from("leaderboard_summary").select("*").eq("word_id",t).order("completion_time_seconds",{ascending:!0}).order("guesses_used",{ascending:!0}).limit(10);if(o)throw console.error("[updateLeaderboardSummary] Failed to fetch leaderboard:",o),o;if(a.length<10||s<a[a.length-1].completion_time_seconds||s===a[a.length-1].completion_time_seconds&&r<a[a.length-1].guesses_used){let{error:o}=await m.from("leaderboard_summary").insert([{player_id:e,word_id:t,rank:a.length+1,was_top_10:!0,best_time_seconds:s,guesses_used:r,created_at:new Date().toISOString()}]);if(o)throw console.error("[updateLeaderboardSummary] Failed to insert leaderboard entry:",o),o}}async function g(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed",details:"Only POST requests are allowed"});try{let a="";await new Promise(t=>{e.on("data",e=>{a+=e.toString()}),e.on("end",()=>t())});let{gameId:o,guess:l,playerId:d}=JSON.parse(a);if(!o||!l||!d)return t.status(400).json({error:"Missing required fields",details:"gameId, guess, and playerId are required"});if(!(0,n.validate)(d))return t.status(400).json({error:"Invalid player ID",details:"player_id must be a valid UUID"});if("string"!=typeof l||!l.trim())return t.status(400).json({error:"Invalid guess",details:"guess must be a non-empty string"});let{data:g,error:p}=await m.from("game_sessions").select("*").eq("id",o).single();if(p||!g)return t.status(404).json({error:"Game session not found",details:p?.message});if(g.is_complete)return t.status(403).json({error:"Game already completed",details:"This game session has already been completed"});let{data:f,error:h}=await m.from("words").select("id, word").eq("id",g.word_id).single();if(h||!f)return t.status(404).json({error:"Word not found",details:h?.message});let w=l.toLowerCase().trim(),E=f.word.toLowerCase().trim(),y=w===E,S=function(e,t){let r=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let t=0;t<=e.length;t++)r[0][t]=t;for(let e=0;e<=t.length;e++)r[e][0]=e;for(let s=1;s<=t.length;s++)for(let a=1;a<=e.length;a++){let o=e[a-1]===t[s-1]?0:1;r[s][a]=Math.min(r[s][a-1]+1,r[s-1][a]+1,r[s-1][a-1]+o)}return r[t.length][e.length]}(w,E),A=!y&&S<=Math.min(3,Math.floor(f.word.length/2)),P=A?function(e,t){let r=[],s=e.toLowerCase(),a=t.toLowerCase();for(let o=0;o<e.length;o++){if(o<t.length&&s[o]===a[o]){r.push(o);continue}a.includes(s[o])&&r.push(o)}return r}(w,E):[],I=[...g.guesses||[],w],O=y||I.length>=6,v=O?Math.floor((Date.now()-new Date(g.start_time).getTime())/1e3):null,U=g.revealed_clues||["definition"],b=[...U];if(!y&&!O){let e=function(e){for(let t of i.D)if(!e.includes(t))return t;return null}(U);e&&b.push(e)}let C={...g.clue_status};b.forEach(e=>{C[e]=!0});let{error:R}=await m.rpc("handle_guess",{p_game_id:o,p_guess:w,p_guesses:I,p_revealed_clues:b,p_clue_status:C,p_is_complete:O,p_is_won:y,p_completion_time_seconds:v});if(R)return console.error("[api/guess] Transaction error:",R),t.status(500).json({error:"Failed to update game state",details:R.message});let j=null,T=null;if(O)try{var r,s;j=await u(d,y,I.length,v),await c(d,f.id,I.length,v,y),y&&await _(d,f.id,I.length,v),r=I.length,s=v||0,T=y?Math.max(0,1e3-(r-1)*100-Math.floor(s/10)):0}catch(e){console.error("[api/guess] Failed to update stats/score:",e)}return t.status(200).json({isCorrect:y,guess:w,isFuzzy:A,fuzzyPositions:P,gameOver:O,revealedClues:b,usedHint:!1,score:T?{value:T,guessesUsed:I.length,completionTimeSeconds:v||0,isWon:y}:null,stats:j?{games_played:j.games_played,games_won:j.games_won,current_streak:j.current_streak,longest_streak:j.longest_streak}:{games_played:0,games_won:0,current_streak:0,longest_streak:0}})}catch(e){return console.error("[api/guess] Unexpected error:",e),t.status(500).json({error:"Unexpected error",details:e instanceof Error?e.message:"Unknown error"})}}let p=(0,l.o)(g);s()}catch(e){s(e)}})},9085:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{O:()=>i});var a=r(9926),o=e([a]);let n=(a=(o.then?(await o)():o)[0]).z.object({SUPABASE_URL:a.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:a.z.string(),SUPABASE_ANON_KEY:a.z.string(),JWT_SECRET:a.z.string(),DB_PROVIDER:a.z.literal("supabase"),NODE_ENV:a.z.literal("production"),PORT:a.z.string().transform(Number).default("3001")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,JWT_SECRET:"2AjThZ7zTBRyjaman+I4yMAJG/acmfiQQ/a+Qey/0q4TDySbcJ0PyDWdVWLppz7wWiGUgfcpSRU2YhXADaNtvw==",DB_PROVIDER:process.env.DB_PROVIDER,NODE_ENV:"production",PORT:process.env.PORT});if(!n.success)throw console.error("❌ Invalid environment variables:\n",Object.entries(n.error.flatten().fieldErrors).map(([e,t])=>`${e}: ${t?.join(", ")}`).join("\n")),Error("Invalid environment variables");let i=n.data;s()}catch(e){s(e)}})},8467:(e,t,r)=>{r.d(t,{D:()=>s});let s=["definition","equivalents","first_letter","in_a_sentence","number_of_letters","etymology"];if(6!==s.length)throw Error("CLUE_SEQUENCE must contain exactly 6 clues");if(new Set(s).size!==s.length)throw Error("CLUE_SEQUENCE contains duplicate clues")},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=141);module.exports=r})();