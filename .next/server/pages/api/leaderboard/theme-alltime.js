"use strict";(()=>{var e={};e.id=73,e.ids=[73],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},430:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>i,routeModule:()=>m});var o=r(1802),n=r(7153),s=r(6249),l=r(7463),d=e([l]);l=(d.then?(await d)():d)[0];let i=(0,s.l)(l,"default"),c=(0,s.l)(l,"config"),m=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/leaderboard/theme-alltime",pathname:"/api/leaderboard/theme-alltime",bundlePath:"",filename:""},userland:l});a()}catch(e){a(e)}})},7274:(e,t,r)=>{r.d(t,{o:()=>a});function a(e){return async(t,r)=>{if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, Player-ID, Authorization"),"OPTIONS"===t.method){r.status(204).end();return}return e(t,r)}}},7463:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>c});var o=r(2885),n=r(9085),s=r(7274),l=e([n]);n=(l.then?(await l)():l)[0];let i=(0,o.createClient)(n.O.SUPABASE_URL,n.O.SUPABASE_SERVICE_ROLE_KEY);async function d(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r;let{player_id:a}=e.query,o="string"==typeof a?a:void 0;console.log("[/api/leaderboard/theme-alltime] Fetching all-time theme leaderboard",{playerId:o});let{data:n,error:s}=await i.from("words").select("theme, date").not("theme","is",null).order("date",{ascending:!0});if(s)return console.error("[/api/leaderboard/theme-alltime] Error fetching theme starts:",s),t.status(500).json({error:"Failed to fetch theme data"});let l=new Map;if(n)for(let e of n)l.has(e.theme)||l.set(e.theme,e.date);console.log("[/api/leaderboard/theme-alltime] Found",l.size,"unique themes");let{data:d,error:c}=await i.from("theme_attempts").select("player_id, theme, attempt_date, is_correct, confidence_percentage").eq("is_correct",!0);if(c)return console.error("[/api/leaderboard/theme-alltime] Error fetching attempts:",c),t.status(500).json({error:"Failed to fetch theme attempts"});if(!d||0===d.length)return console.log("[/api/leaderboard/theme-alltime] No correct theme guesses found"),t.status(200).json({leaderboard:[],totalPlayers:0});let m=new Map;for(let e of d){let{player_id:t,theme:r,attempt_date:a,confidence_percentage:o}=e;m.has(t)||m.set(t,{themesUnlocked:new Set,dayNumbers:[],confidenceScores:[],totalCorrect:0,totalAttempts:0});let n=m.get(t);n.themesUnlocked.add(r),n.totalCorrect++,null!=o&&n.confidenceScores.push(o);let s=l.get(r);if(s){let e=new Date(s),t=new Date(a),r=Math.floor((t.getTime()-e.getTime())/864e5)+1,o=Math.max(1,Math.min(7,r));n.dayNumbers.push(o)}}let{data:u,error:h}=await i.from("theme_attempts").select("player_id").in("player_id",Array.from(m.keys()));if(!h&&u){let e=new Map;for(let t of u)e.set(t.player_id,(e.get(t.player_id)||0)+1);Array.from(m.entries()).forEach(([t,r])=>{r.totalAttempts=e.get(t)||r.totalCorrect})}let p=Array.from(m.keys()),{data:f,error:y}=await i.from("players").select("id, display_name").in("id",p);if(y)return console.error("[/api/leaderboard/theme-alltime] Error fetching players:",y),t.status(500).json({error:"Failed to fetch player data"});let A=new Map(f?.map(e=>[e.id,e.display_name||"Anonymous"])||[]),E=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],P=Array.from(m.entries()).map(([e,t])=>{let r=t.dayNumbers.length>0?t.dayNumbers.reduce((e,t)=>e+t,0)/t.dayNumbers.length:0,a=t.confidenceScores.length>0?Math.round(t.confidenceScores.reduce((e,t)=>e+t,0)/t.confidenceScores.length):0;return{rank:0,playerId:e,displayName:A.get(e)||"Anonymous",themesUnlocked:t.themesUnlocked.size,avgDayGuessed:Math.round(10*r)/10,avgDayName:E[Math.max(1,Math.min(7,Math.round(r)))],avgConfidence:a,totalCorrect:t.totalCorrect,totalAttempts:t.totalAttempts,successRate:t.totalAttempts>0?Math.round(t.totalCorrect/t.totalAttempts*1e3)/10:0,isCurrentPlayer:!!o&&e===o}}).filter(e=>e.themesUnlocked>0).sort((e,t)=>t.themesUnlocked!==e.themesUnlocked?t.themesUnlocked-e.themesUnlocked:e.avgDayGuessed!==t.avgDayGuessed?e.avgDayGuessed-t.avgDayGuessed:t.successRate-e.successRate);P.forEach((e,t)=>{e.rank=t+1}),o&&(r=P.find(e=>e.playerId===o)),console.log("[/api/leaderboard/theme-alltime] Leaderboard generated:",{totalPlayers:P.length,hasPlayerRank:!!r});let g=P.slice(0,20);return t.status(200).json({leaderboard:g,playerRank:r&&r.rank>20?r:void 0,totalPlayers:P.length})}catch(e){return console.error("[/api/leaderboard/theme-alltime] Unexpected error:",e),t.status(500).json({error:"Internal server error"})}}let c=(0,s.o)(d);a()}catch(e){a(e)}})},9085:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{O:()=>l});var o=r(9926),n=e([o]);let s=(o=(n.then?(await n)():n)[0]).z.object({SUPABASE_URL:o.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:o.z.string(),SUPABASE_ANON_KEY:o.z.string(),DB_PROVIDER:o.z.literal("supabase"),NODE_ENV:o.z.enum(["development","production"]).default("production"),PORT:o.z.string().transform(Number).default("3001"),FRONTEND_URL:o.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:"supabase",NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!s.success)throw console.error("âŒ Invalid environment variables:\n",Object.entries(s.error.flatten().fieldErrors).map(([e,t])=>`${e}: ${t?.join(", ")}`).join("\n")),Error("Invalid environment variables");let l=s.data;a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=430);module.exports=r})();