"use strict";(()=>{var e={};e.id=633,e.ids=[633],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},614:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>i,routeModule:()=>u});var o=r(1802),n=r(7153),l=r(6249),s=r(3705),d=e([s]);s=(d.then?(await d)():d)[0];let i=(0,l.l)(s,"default"),c=(0,l.l)(s,"config"),u=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/leaderboard/theme-weekly",pathname:"/api/leaderboard/theme-weekly",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},7274:(e,t,r)=>{r.d(t,{o:()=>a});function a(e){return async(t,r)=>{if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, Player-ID, Authorization"),"OPTIONS"===t.method){r.status(204).end();return}return e(t,r)}}},3705:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>c});var o=r(2885),n=r(9085),l=r(7274),s=e([n]);n=(s.then?(await s)():s)[0];let i=(0,o.createClient)(n.O.SUPABASE_URL,n.O.SUPABASE_SERVICE_ROLE_KEY);async function d(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r;let{player_id:a}=e.query,o="string"==typeof a?a:void 0;console.log("[/api/leaderboard/theme-weekly] Fetching weekly theme leaderboard",{playerId:o});let n=new Date,l=n.getDay(),s=new Date(n);s.setDate(n.getDate()-(0===l?6:l-1)),s.setHours(0,0,0,0);let d=new Date(s);d.setDate(s.getDate()+7),console.log("[/api/leaderboard/theme-weekly] Week boundaries:",{thisMonday:s.toISOString().split("T")[0],nextMonday:d.toISOString().split("T")[0]});let{data:c,error:u}=await i.from("words").select("theme, word, date").gte("date",s.toISOString().split("T")[0]).lt("date",d.toISOString().split("T")[0]).not("theme","is",null).order("date",{ascending:!0}).limit(7);if(u)return console.error("[/api/leaderboard/theme-weekly] Error fetching theme:",u),t.status(500).json({error:"Failed to fetch current theme"});if(!c||0===c.length)return console.log("[/api/leaderboard/theme-weekly] No theme found for current week"),t.status(200).json({currentTheme:null,leaderboard:[],totalPlayers:0});let p=c[0].theme;console.log("[/api/leaderboard/theme-weekly] Current theme:",p);let{data:m,error:h}=await i.from("words").select("date").eq("theme",p).order("date",{ascending:!0}).limit(1);if(h||!m||0===m.length)return console.error("[/api/leaderboard/theme-weekly] Error finding theme start:",h),t.status(500).json({error:"Failed to find theme start date"});let y=m[0].date;console.log("[/api/leaderboard/theme-weekly] Theme started on:",y);let{data:f,error:g}=await i.from("theme_attempts").select(`
        player_id,
        attempt_date,
        created_at,
        is_correct,
        confidence_percentage
      `).eq("theme",p).eq("is_correct",!0).order("attempt_date",{ascending:!0}).order("created_at",{ascending:!0});if(g)return console.error("[/api/leaderboard/theme-weekly] Error fetching attempts:",g),t.status(500).json({error:"Failed to fetch theme attempts"});if(!f||0===f.length)return console.log("[/api/leaderboard/theme-weekly] No correct guesses yet"),t.status(200).json({currentTheme:p,leaderboard:[],totalPlayers:0});let _=f.map(e=>e.player_id),{data:A,error:E}=await i.from("players").select("id, display_name").in("id",_);if(E)return console.error("[/api/leaderboard/theme-weekly] Error fetching players:",E),t.status(500).json({error:"Failed to fetch player data"});let P=new Map(A?.map(e=>[e.id,e.display_name||"Anonymous"])||[]),S=f.map((e,t)=>{let r=new Date(e.attempt_date),a=new Date(y),n=Math.floor((r.getTime()-a.getTime())/864e5),l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][r.getDay()],s=new Date(e.created_at),d=String(s.getHours()).padStart(2,"0"),i=String(s.getMinutes()).padStart(2,"0"),c=`${d}:${i}`;return{rank:t+1,playerId:e.player_id,displayName:P.get(e.player_id)||"Anonymous",dayNumber:n+1,dayName:l,timeGuessed:c,confidencePercent:e.confidence_percentage||0,createdAt:e.created_at,isCurrentPlayer:!!o&&e.player_id===o}});o&&(r=S.find(e=>e.playerId===o)),console.log("[/api/leaderboard/theme-weekly] Leaderboard generated:",{theme:p,totalPlayers:S.length,hasPlayerRank:!!r});let w=S.slice(0,20);return t.status(200).json({currentTheme:p,leaderboard:w,playerRank:r&&r.rank>20?r:void 0,totalPlayers:S.length})}catch(e){return console.error("[/api/leaderboard/theme-weekly] Unexpected error:",e),t.status(500).json({error:"Internal server error"})}}let c=(0,l.o)(d);a()}catch(e){a(e)}})},9085:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{O:()=>s});var o=r(9926),n=e([o]);let l=(o=(n.then?(await n)():n)[0]).z.object({SUPABASE_URL:o.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:o.z.string(),SUPABASE_ANON_KEY:o.z.string(),DB_PROVIDER:o.z.literal("supabase"),NODE_ENV:o.z.enum(["development","production"]).default("production"),PORT:o.z.string().transform(Number).default("3001"),FRONTEND_URL:o.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:"supabase",NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!l.success)throw console.error("âŒ Invalid environment variables:\n",Object.entries(l.error.flatten().fieldErrors).map(([e,t])=>`${e}: ${t?.join(", ")}`).join("\n")),Error("Invalid environment variables");let s=l.data;a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=614);module.exports=r})();