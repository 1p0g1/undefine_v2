"use strict";(()=>{var e={};e.id=917,e.ids=[917],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,a){return a in r?r[a]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,a)):"function"==typeof r&&"default"===a?r:void 0}}})},3998:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.r(r),a.d(r,{config:()=>c,default:()=>d,routeModule:()=>u});var o=a(1802),s=a(7153),n=a(6249),i=a(5595),l=e([i]);i=(l.then?(await l)():l)[0];let d=(0,n.l)(i,"default"),c=(0,n.l)(i,"config"),u=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/cron/finalize-daily-leaderboards",pathname:"/api/cron/finalize-daily-leaderboards",bundlePath:"",filename:""},userland:i});t()}catch(e){t(e)}})},5595:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.r(r),a.d(r,{default:()=>i,manualTriggerFinalization:()=>d});var o=a(2885),s=a(9085),n=e([s]);s=(n.then?(await n)():n)[0];let c=(0,o.createClient)(s.O.SUPABASE_URL,s.O.SUPABASE_SERVICE_ROLE_KEY);async function i(e,r){let a=Date.now(),t=new Date().toISOString();console.log("[/api/cron/finalize-daily-leaderboards] Starting daily finalization at:",t);let o=e.headers["user-agent"]?.includes("vercel-cron")||"1"===e.headers["x-vercel-cron"],n="development"===s.O.NODE_ENV;if(!o&&!n)return console.log("[/api/cron/finalize-daily-leaderboards] Unauthorized cron request"),r.status(401).json({success:!1,message:"Unauthorized: This endpoint is only accessible via Vercel Cron",finalized:[],errors:[{error:"Unauthorized cron request"}],stats:{totalProcessed:0,successCount:0,errorCount:1,executionTime:"0ms",cronTime:t}});try{let e=await l(),o=`${Date.now()-a}ms`;return console.log("[/api/cron/finalize-daily-leaderboards] Completed in:",o,"Stats:",e.stats),r.status(200).json({...e,stats:{...e.stats,executionTime:o,cronTime:t}})}catch(o){let e=`${Date.now()-a}ms`;return console.error("[/api/cron/finalize-daily-leaderboards] Fatal error:",o),r.status(500).json({success:!1,message:o instanceof Error?o.message:"Unknown error",finalized:[],errors:[{error:o instanceof Error?o.message:"Unknown error"}],stats:{totalProcessed:0,successCount:0,errorCount:1,executionTime:e,cronTime:t}})}}async function l(){let e={success:!0,message:"",finalized:[],errors:[],stats:{totalProcessed:0,successCount:0,errorCount:0}};try{let r=new Date;r.setUTCDate(r.getUTCDate()-1);let a=r.toISOString().split("T")[0];console.log("[autoFinalizeYesterdaysLeaderboards] Finalizing leaderboards for date:",a);let{data:t,error:o}=await c.from("leaderboard_summary").select("word_id").eq("date",a);if(o)throw Error(`Failed to find words to finalize: ${o.message}`);if(!t||0===t.length)return e.message=`No words found for ${a} - nothing to finalize`,e;let s=Array.from(new Set(t.map(e=>e.word_id)));console.log("[autoFinalizeYesterdaysLeaderboards] Found",s.length,"unique words to finalize");let{data:n}=await c.from("daily_leaderboard_snapshots").select("word_id").in("word_id",s).eq("date",a).eq("is_finalized",!0),i=new Set(n?.map(e=>e.word_id)||[]),l=s.filter(e=>!i.has(e));for(let r of(console.log("[autoFinalizeYesterdaysLeaderboards] Words needing finalization:",l.length),l))try{let{data:t,error:o}=await c.rpc("finalize_daily_leaderboard",{target_word_id:r,target_date:a});if(o){console.error("[autoFinalizeYesterdaysLeaderboards] Finalization failed for word:",r,o.message),e.errors.push({word_id:r,date:a,error:o.message});continue}let s=t?.[0];s?.success?(e.finalized.push({word_id:r,date:a,total_players:s.total_players,top_10_count:s.top_10_count}),console.log("[autoFinalizeYesterdaysLeaderboards] Successfully finalized:",r,"with",s.total_players,"players")):e.errors.push({word_id:r,date:a,error:s?.message||"Unknown finalization error"})}catch(t){console.error("[autoFinalizeYesterdaysLeaderboards] Error processing word:",r,t),e.errors.push({word_id:r,date:a,error:t instanceof Error?t.message:"Unknown error"})}let d=e.finalized.length+e.errors.length,u=e.finalized.length,f=e.errors.length;return e.stats={totalProcessed:d,successCount:u,errorCount:f},u>0&&0===f?e.message=`Successfully finalized ${u} leaderboard(s) for ${a}`:u>0&&f>0?e.message=`Finalized ${u} leaderboard(s) for ${a} with ${f} error(s)`:0===d?e.message=`All leaderboards for ${a} were already finalized`:(e.message=`Failed to finalize any leaderboards for ${a} (${f} error(s))`,e.success=!1),e}catch(r){return console.error("[autoFinalizeYesterdaysLeaderboards] Fatal error:",r),e.success=!1,e.message=r instanceof Error?r.message:"Unknown error",e.errors.push({error:r instanceof Error?r.message:"Unknown error"}),e}}async function d(){if("development"!==s.O.NODE_ENV)throw Error("Manual trigger only available in development");let e=Date.now(),r=await l();return{...r,stats:{...r.stats,executionTime:`${Date.now()-e}ms`,cronTime:new Date().toISOString()}}}t()}catch(e){t(e)}})},9085:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.d(r,{O:()=>i});var o=a(9926),s=e([o]);let n=(o=(s.then?(await s)():s)[0]).z.object({SUPABASE_URL:o.z.string().url(),SUPABASE_SERVICE_ROLE_KEY:o.z.string(),SUPABASE_ANON_KEY:o.z.string(),DB_PROVIDER:o.z.literal("supabase"),NODE_ENV:o.z.enum(["development","production"]).default("production"),PORT:o.z.string().transform(Number).default("3001"),FRONTEND_URL:o.z.string().url().default("http://localhost:5173")}).safeParse({SUPABASE_URL:process.env.SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhY2xsand2c2ljZXpta2pubGJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDAyOTc3MiwiZXhwIjoyMDU5NjA1NzcyfQ.qAwl1_vgAK8qMv44dOWPoZ6u_w5PqwGEdRmOgXeKJbY",SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY,DB_PROVIDER:"supabase",NODE_ENV:"production",PORT:process.env.PORT,FRONTEND_URL:process.env.FRONTEND_URL});if(!n.success)throw console.error("âŒ Invalid environment variables:\n",Object.entries(n.error.flatten().fieldErrors).map(([e,r])=>`${e}: ${r?.join(", ")}`).join("\n")),Error("Invalid environment variables");let i=n.data;t()}catch(e){t(e)}})},7153:(e,r)=>{var a;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,r,a)=>{e.exports=a(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var a=r(r.s=3998);module.exports=a})();